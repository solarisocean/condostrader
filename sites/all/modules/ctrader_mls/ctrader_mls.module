<?php
/**
 * Created by PhpStorm.
 * User: aryan
 * Date: 03.04.16
 * Time: 15:50
 */

/**
 * Implements hook_menu().
 */
function ctrader_mls_menu() {
  $items['admin/config/mls'] = array(
    'title' => 'Mls integration page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ctrader_mls_form'),
    'access arguments' => array('administer modules'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/rets'] = array(
    'title' => 'RETS settings page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ctrader_mls_rets_data_form'),
    'access arguments' => array('administer modules'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['rets-connection-test'] = array(
    'title' => 'RETS connection',
    'page callback' => '_rets_connection_test',
    'access arguments' => array('administer modules'),
    'file' => 'inc/ctrader_mls.rets_connection.inc',
  );
  $items['rets-xml-parser'] = array(
    'title' => 'RETS xml parser',
    'page callback' => '_rets_xml_parser',
    'access arguments' => array('administer modules'),
    'file' => 'inc/ctrader_mls.rets_xml_parser.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  // создаем страницу с формой для запуска обработки
  $items['import-condo-xml'] = array(
    'title' => 'Import data from XML file',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('xml_import_form'),
    'access callback' => TRUE,
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'main-menu',
  );

  return $items;
}

/**
 * Form for configure integration drupal and mls.
 */
function ctrader_mls_form($form, &$form_state) {
  $form['mls_username'] = array(
    '#type' => 'textfield',
    '#title' => t('Username'),
    '#default_value' => variable_get('mls_username', ''),
  );

  $form['mls_password'] = array(
    '#type' => 'password',
    '#title' => t('Password'),
  );

  return system_settings_form($form);
}

/**
 * Form for configure RETS server login data.
 */
function ctrader_mls_rets_data_form($form, &$form_state) {
  $form['rets_login_url'] = array(
    '#type' => 'textfield',
    '#title' => t('RETS login url'),
    '#default_value' => variable_get('rets_login_url', ''),
  );

  $form['rets_username'] = array(
    '#type' => 'textfield',
    '#title' => t('RETS username'),
    '#default_value' => variable_get('rets_username', ''),
  );

  $form['rets_password'] = array(
    '#type' => 'textfield',
    '#title' => t('RETS password'),
    '#default_value' => variable_get('rets_password', ''),

  );

  $form['rets_user_agent'] = array(
    '#type' => 'textfield',
    '#title' => t('RETS user agent'),
    '#default_value' => variable_get('rets_user_agent', ''),
  );

  $form['rets_user_agent_password'] = array(
    '#type' => 'textfield',
    '#title' => t('RETS user agent password'),
    '#default_value' => variable_get('rets_user_agent_password', ''),

  );

  return system_settings_form($form);
}


/**
 * Implements hook_libraries_info().
 */
function ctrader_mls_libraries_info() {
  $libraries['torontomlsapi'] = array(
    'name' => 'Torontomlsapi',
    'vendor url' => 'https://github.com/tamtranvn2012/torontomlsapi',
    'download url' => 'https://github.com/tamtranvn2012/torontomlsapi/archive/master.zip',
    'version arguments' => array(
      'file' => 'phrets.php',
      'pattern' => '@version\s+([0-9a-zA-Z\.-]+)@',
    ),
    'files' => array(
      'php' => array(
        'phrets.php',
      ),
    ),
  );

  return $libraries;
}


/**
 * Large XML import form.
 */
function xml_import_form() {
  $form = array();

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Start import'),
  );

  return $form;
}

/**
 * Large XML import start.
 */
function xml_import_form_submit($form, &$form_state) {
  $batch = array(
    'operations' => array(
      array('large_xml_import_operation', array()),
    ),
    'finished' => 'large_xml_import_finished',
    'title' => t('Processing large XML'),
    'init_message' => t('Large XML Batch is starting.'),
    'progress_message' => t('Processed @current out of @total.'),
    'error_message' => t('Large XML Batch has encountered an error.'),
  );
  batch_set($batch);
}

/**
 * Large XML test operation.
 */
function large_xml_import_operation(&$context) {

  $condos = array();
  $xml = simplexml_load_file(drupal_get_path('module', 'ctrader_mls') . '/files/cnd_test_xml/cnd.xml');
  foreach ($xml->REData->REProperties->CondoProperty as $condo) {
    $condos[] = $condo;
  }

  $condo_count = count($condos);

  $items_per_pass = 10;
  if (!isset($context['sandbox']['progress'])) {
    $context['sandbox']['progress'] = 0;
    $context['sandbox']['current'] = 0;
    $context['sandbox']['max'] = $condo_count;
  }

  $records = array_slice($condos, $context['sandbox']['current'], $items_per_pass);

  if (!empty($records)) {

    $rets_login_url = variable_get('rets_login_url', '');
    $rets_username = variable_get('rets_username', '');
    $rets_password = variable_get('rets_password', '');
    $rets_user_agent = variable_get('rets_user_agent', '');
    $rets_user_agent_password = variable_get('rets_user_agent_password', '');


    $connection = entity_load('drealty_connection_entity', array('toronto_rets_connection'));
    $connection = end($connection);
    $field_mappings = $connection->FetchFieldMappings();

    $rets = new phRETS;
    $rets->Connect($rets_login_url, $rets_username, $rets_password, $rets_user_agent_password);
    $fields_metadata = $rets->GetMetadataTable("Property", "CondoProperty");

    $items = array();
    foreach ($records as $key => $condo) {

      $item = entity_create('drealty_listing', array(
        'id' => NULL,
        'type' => 'toronto_condo',
        'conid' => NULL,
        'hash' => NULL,
        'process_images' => NULL,
        'rets_imported' => FALSE,
        'status' => NULL,
        'rets_key' => $condo->Listing->MLS->__toString(),
        'rets_id' => $condo->Listing->MLS->__toString(),
        'class' => NULL,
        'active' => NULL,
        'label' => $condo->Listing->Address->__toString(),
        'created' => REQUEST_TIME,
        'changed' => REQUEST_TIME,
      ));
      foreach ($field_mappings as $mapping) {
        $ftype = $mapping->field_api_type;
        switch ($ftype) {
          case 'text':
            foreach ($fields_metadata as $field_data) {
              if ($mapping->systemname == $field_data['SystemName']) {
                $field_standart_name = $field_data['StandardName'];
                $field_value = $condo->Listing->{$field_standart_name}->__toString();

                $item->{$mapping->field_name}[LANGUAGE_NONE][0]['value'] = isset($field_value) ? $field_value : NULL;
              }
            }
            break;
          case 'number_integer':
          case 'number_decimal':
          case 'number_float':
            foreach ($fields_metadata as $field_data) {
              if ($mapping->systemname == $field_data['SystemName']) {
                $field_standart_name = $field_data['StandardName'];
                $field_value = $condo->Listing->{$field_standart_name}->__toString();

                $item->{$mapping->field_name}[LANGUAGE_NONE][0]['value'] = isset($field_value) ? $field_value : NULL;
              }
            }
            break;
          case 'text_long':
            foreach ($fields_metadata as $field_data) {
              if ($mapping->systemname == $field_data['SystemName']) {
                $field_standart_name = $field_data['StandardName'];
                $field_value = $condo->Listing->{$field_standart_name}->__toString();

                $item->{$mapping->field_name}[LANGUAGE_NONE][0]['value'] = isset($field_value) ? $field_value : NULL;
                $item->{$mapping->field_name}[LANGUAGE_NONE][0]['format'] = 'plain_text';
              }
            }
            break;
        }
      }
      $items[] = $item;
    }

    foreach ($items as $entity_presave) {
      $entity_presave->save();
    }

    $context['sandbox']['current'] = $context['sandbox']['progress'] + $key + 1;
    $context['sandbox']['progress'] += count($records);

    $context['finished'] = $context['sandbox']['progress'] / $context['sandbox']['max'];
    if ($context['finished'] >= 1) {
      $context['finished'] = 1;
    }
//    if ($context['sandbox']['progress'] > 200) {
//      $context['finished'] = 1;
//    }
  }
}

/**
 * Batch finished callback.
 */
function large_xml_import_finished($success, $results, $operations) {
  if ($success) {
    $message = t('Import successful finished.');
  }
  else {
    $message = t('Finished with an error.');
  }

  drupal_set_message($message);
}
