<?php

// alias for search result page.
define('CTRADER_SEARCH_RESULT_PAGE', 'search-results');


/**
 * Implements hook_init().
 */
function ctrader_saf_init() {
  drupal_add_css(drupal_get_path('module', 'ctrader_saf') . '/css/ctrader_saf.css');
  drupal_add_js(drupal_get_path('module', 'ctrader_saf') . '/js/facets_script.js');
}


/**
 * Implements hook_js_alter().
 */
function ctrader_saf_js_alter(&$javascript) {
  $current_path = current_path();
  if ($current_path == 'main-page' || $current_path == '' || $current_path == CTRADER_SEARCH_RESULT_PAGE) {
    if (isset($javascript['sites/all/modules/facetapi/facetapi.js']) && isset($javascript['sites/all/modules/ctrader_saf/js/rewritten_search_api_ranges.js'])) {
      unset($javascript['sites/all/modules/facetapi/facetapi.js']);
    }
  }
}


/**
 * Implements hook_menu().
 */
function ctrader_saf_menu() {
  $items = array();
  $items['search-link-calculate'] = array(
    'title' => 'Search link calculating page',
    'page callback' => '_ctrader_saf_search_link_calculate_page_callback',
    'access callback' => TRUE,
  );
  return $items;
}


/**
 * Implements hook_form_alter().
 */
function ctrader_saf_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'views_exposed_form' && $form['#id'] == 'views-exposed-form-search-results-ctrader-block-1') {
//    $form['sort_bef_combine']['#default_value'] = '';
  }
  if ($form_id == 'search_api_ranges_block_slider_view_form_field_sqft_range_max__torcond') {
//    $form['range-min']['#value'] = 0;
//    $form_state['build_info']['args'][0]['min'] = 0;
  }
  if ($form_id == 'search_api_ranges_block_slider_view_form_field_lp_dol__torcond' || $form_id == 'search_api_ranges_block_slider_view_form_field_sqft_range_max__torcond') {
    $form['#submit'] = array();
    $form['submit']['#ajax'] = array(
      'callback' => '_ctrader_saf_range_ajax_form_submit',
      'effect' => 'fade',
    );
    foreach ($form['#attached']['js'] as $key => $value) {
      if (is_string($value) && strpos($value, '/search_api_ranges/search_api_ranges.js')) {
        $form['#attached']['js'][$key] = drupal_get_path('module', 'ctrader_saf') . '/js/rewritten_search_api_ranges.js';
      }
    }
  }
  if ($form_id == 'views_exposed_form' && $form['#id'] == 'views-exposed-form-search-results-ctrader-page-1') {
    $form['#action'] = '/' . CTRADER_SEARCH_RESULT_PAGE;
    if (drupal_get_path_alias() == CTRADER_SEARCH_RESULT_PAGE) {

      // Needs for notice error disabling.
      if (!isset($form_state['#combine_param'])) {
        $form_state['#combine_param'] = 'del';
        $form_state['values']['del'] = '';
        $form_state['values']['sorting'] = '';
      }

      $form['search_api_aggregation_1']['#type'] = 'hidden';
      $form['#info']['filter-search_api_aggregation_1']['label'] = '';
    }
    elseif (drupal_is_front_page()) {
      $form['sorting']['#type'] = 'hidden';
      $form['search_api_aggregation_1']['#attributes']['placeholder'] = t('Search by Neighbourhood, Condo Address or Name ...');
      $form['search_api_aggregation_1']['#size'] = 70;
    }
  }

  // Show only needed fields in index field form (problem with large data in POST).
  if ($form_id == 'search_api_admin_index_fields') {
    foreach ($form['fields'] as $key => $field) {
      if (strpos($key, 'field_reference_to_condo:') !== FALSE) {
        $needs_referenced_fields = array(
          ':field_lp_dol__torcond',
          ':field_s_r__torcond',
          ':field_price_per_sqft__torcond',
          ':field_sqft__torcond',
          ':field_reference_to_condo',
        );
        $delete_field = TRUE;
        foreach ($needs_referenced_fields as $value) {
          if (strpos($key, $value) !== FALSE) {
            $delete_field = FALSE;
          }
        }
        if ($delete_field) {
          unset($form['fields'][$key]);
        }
      }
    }
  }
}


/**
 * Implements hook_search_api_ranges_minmax_alter().
 */
function ctrader_saf_search_api_ranges_minmax_alter(&$variables, &$order) {
  if ($variables['range_field'] == 'field_sqft_range_max__torcond') {

  }
}


/**
 * Implements hook_entity_presave().
 */
function ctrader_saf_entity_presave($entity, $type) {
  switch ($type) {
    case DREALTY_ENTITY_TYPE:
      $sqft_min = $sqft_max = 0;
      if (isset($entity->field_sqft__torcond[LANGUAGE_NONE][0]['value'])) {
        $sqft = $entity->field_sqft__torcond[LANGUAGE_NONE][0]['value'];
        if (strrpos($sqft, '-')) {
          $sqft = explode('-', $sqft);
          $sqft_min = intval($sqft[0]);
          $sqft_max = intval($sqft[1]);
        }
        else {
          $sqft_min = $sqft_max = intval($sqft);
        }
      }
      $entity->field_sqft_range_min__torcond[LANGUAGE_NONE][0]['value'] = $sqft_min;
      $entity->field_sqft_range_max__torcond[LANGUAGE_NONE][0]['value'] = $sqft_max;

      $price = isset($entity->field_lp_dol__torcond[LANGUAGE_NONE][0]['value']) ? intval($entity->field_lp_dol__torcond[LANGUAGE_NONE][0]['value']) : 0;
      $entity->field_price_per_sqft__torcond[LANGUAGE_NONE][0]['value'] = $sqft_max != 0 ? round(($price / $sqft_max), 2) : 0;
      break;
  }
}


/**
 * Implements hook_search_api_solr_query_alter().
 */
function ctrader_saf_search_api_solr_query_alter(array &$call_args, SearchApiQueryInterface $query) {
  $facet_item = $query->getFilter()->getFilters();
  foreach ($facet_item as $item) {
    if (is_object($item) && is_object(reset($item->getFilters()))) {
      $filters = $item->getFilters()[0]->getFilters();

      // Changes query for range facet (field: sqft).
      // Makes one range form for two fields.
      $sqft_rage_field_name = 'field_sqft_range_max__torcond';
      $sqft_rage_field_name_hidden_secondary = 'field_sqft_range_min__torcond';
      $key_to_write_custom_query = '';
      $min_range_value = $max_range_value = '*';
      if (!empty($filters[0]) && is_array($filters[0]) && $filters[0][0] == $sqft_rage_field_name) {
        if (!empty($filters[0][1])) {
          foreach ($filters as $value) {
            if ($value[0] == $sqft_rage_field_name) {
              if ($value[2] == '>=') {
                $min_range_value = $value[1];
              }
              if ($value[2] == '<=') {
                $max_range_value = $value[1];
              }
            }
          }
          foreach ($call_args['params']['fq'] as $key => $value) {
            if (strpos($value, '{!tag=facet:' . $sqft_rage_field_name . '}') !== FALSE) {
              unset($call_args['params']['fq'][$key]);
              $key_to_write_custom_query = $key;
            }
          }
          $call_args['params']['fq'][$key_to_write_custom_query] = 'is_' . $sqft_rage_field_name . ':[' . $min_range_value . ' TO ' . $max_range_value . '] OR is_' . $sqft_rage_field_name_hidden_secondary . ':[' . $min_range_value . ' TO ' . $max_range_value . ']';

          /**
           * Query examples for range facet.
           *
           * $call_args['params']['fq'][0] = 'is_field_test_range_max:["300" TO "700"] OR is_field_test_range_min:["300" TO "700"]';
           *
           * $call_args['params']['fq'][0] = '{!tag=facet:field_test_range_max}is_field_test_range_max:["300" TO *]';
           * $call_args['params']['fq'][1] = '{!tag=facet:field_test_range_max}is_field_test_range_max:[* TO "700"]';
           */
        }
      }
    }
  }

  if (!empty($facet_item) && isset($facet_item[0]) && is_object($facet_item[0])) {
    $facet_item = $facet_item[0]->getFilters();

    // Changes query for item 'Owned' in field:locker facet.
    // Makes one checkbox for all possible options (except 'None').
    if (!empty($facet_item[0]) && is_array($facet_item[0]) && $facet_item[0][0] == 'field_locker__torcond') {
      if (!empty($facet_item[0][1])) {
        $facet_item = $facet_item[0][1];
        if ($facet_item !== 'None') {
          $call_args['params']['fq'][0] = '{!tag=facet:field_locker__torcond}((ss_field_locker__torcond:"Owned") OR (ss_field_locker__torcond:"Exclusive") OR (ss_field_locker__torcond:"Ensuite") OR (ss_field_locker__torcond:"Ensuite+Owned") OR (ss_field_locker__torcond:"Common") OR (ss_field_locker__torcond:"Ensuite+Exclusive"))';
        }
      }
    }
  }
}


/**
 * Implements hook_facet_items_alter().
 */
function ctrader_saf_facet_items_alter(&$build, &$settings) {
  switch ($settings->facet) {
    case 'field_locker__torcond':
      $replace_this_facet = 'Owned';
      $replaced_facet_count_number = 0;
      foreach ($build as $key => $item) {
        switch ($key) {
          case $replace_this_facet:
            $build[$replace_this_facet]['#markup'] = l(t('Require Locker'), '');
            $build[$replace_this_facet]['#html'] = TRUE;
            $build[$replace_this_facet]['#indexed_value'] = t('Require Locker');
            break;
          // Remove this facet item.
          default:
            unset($build[$key]);
            break;
        }
        if ($key != 'None') {
          $replaced_facet_count_number += isset($item['#count']) ? $item['#count'] : 0;
        }
      }
      $build[$replace_this_facet]['#count'] = $replaced_facet_count_number;
      break;
    case 'field_pets__torcond':
      $replace_this_facet = 'Restrict';
      $replaced_facet_count_number = 0;
      foreach ($build as $key => $item) {
        switch ($key) {
          case $replace_this_facet:
            $build[$replace_this_facet]['#markup'] = l(t('Pets Allowed'), '');
            $build[$replace_this_facet]['#html'] = TRUE;
            break;
          case 'N':
            unset($build[$key]);
          default;
        }
      }
      break;
    case 'field_br__torcond':
      $adapter = facetapi_adapter_load($settings->searcher);
      $facet = facetapi_facet_load($settings->facet, $settings->searcher);
      $items = $adapter->getActiveItems($facet);
      $item_values = array();

      foreach ($build as $key => $build_item) {
        $build[$key]['#html'] = TRUE;
        $build[$key]['#markup'] = l(t($build_item['#markup']), '');
      }

      foreach ($items as $item) {
        $item_values[] = $item['value'];
      }
      $is_all_link_active = count($items) == 0;
      $all_link_path = $adapter->getFacetPath($facet, $item_values, TRUE);
      $all_link_query = $adapter->getQueryString($facet, $item_values, TRUE);
      $build['any'] = array(
        '#markup' => l(t('Any'), ''),
        '#path' => $all_link_path,
        '#html' => TRUE,
        '#count' => NULL,
        '#indexed_value' => 0,
        '#active' => $is_all_link_active,
        '#item_parents' => array(),
        '#item_children' => array(),
        '#query' => $all_link_query,
      );
      break;
    case 'field_prkg_inc__torcond':
      unset($build['N']);
      $build['Y']['#markup'] = l(t('Require Parking'), '');
      $build['Y']['#html'] = TRUE;
      break;
    case 'field_s_r__torcond':
      $build['Lease']['#markup'] = l(t('For rent'), '');
      $build['Sale']['#markup'] = l(t('For sale'), '');
      $build['Sale']['#html'] = $build['Lease']['#html'] = TRUE;

      // Makes this item active on homepage load.
      if (isset($_SESSION['search_link_calculate']['f']) && drupal_get_path_alias() != 'results') {
        foreach ($_SESSION['search_link_calculate']['f'] as $value) {
          if (strpos($value, 'field_s_r__torcond') !== FALSE) {
            $field_search_data = explode(':', $value);
            $build[$field_search_data[1]]['#active'] = TRUE;
          }
        }
      }
      break;
    case 'field_sqft_range_max__torcond':

      break;
  }
}


/**
 * Implements hook_current_search_items().
 */
function ctrader_saf_current_search_items() {

}


/**
 * Implements hook_block_info().
 */
function ctrader_saf_block_info() {
  $blocks['ctrader_search_button'] = array(
    'info' => t('Custom block: Search button form'),
  );
  return $blocks;
}


/**
 * Implements hook_block_view().
 */
function ctrader_saf_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'ctrader_search_button':
      $block['subject'] = t('Block with search button for facet search');
      $block['content'] = _ctrader_saf_blocks_content_function($delta);

      break;
  }
  return $block;
}

function _ctrader_saf_blocks_content_function($delta) {
  switch ($delta) {
    case 'ctrader_search_button':
      $alias = drupal_get_path_alias();
      $reset_search_option = TRUE;
      if ($alias == 'main-page') {
        if (isset($_POST['form_id']) && $_POST['form_id'] == '_ctrader_saf_search_button_form') {
          $reset_search_option = FALSE;
        }
        if ($reset_search_option) {
          if (isset($_SESSION['search_link_calculate'])) {
            unset($_SESSION['search_link_calculate']);
          }
          $min_value_sqft = db_query('SELECT MIN(field_sqft_range_min__torcond_value) FROM {field_data_field_sqft_range_min__torcond}')->fetchField();
          $max_value_sqft = db_query('SELECT MAX(field_sqft_range_max__torcond_value) FROM {field_data_field_sqft_range_max__torcond}')->fetchField();
          $min_value_price = round(db_query('SELECT MIN(field_lp_dol__torcond_value) FROM {field_data_field_lp_dol__torcond}')->fetchField());
          $max_value_price = round(db_query('SELECT MAX(field_lp_dol__torcond_value) FROM {field_data_field_lp_dol__torcond}')->fetchField());
          $_SESSION['search_link_calculate']['f'] = array(
            'field_s_r__torcond:Sale',
            'field_sqft_range_max__torcond:[' . $min_value_sqft . ' TO ' . $max_value_sqft . ']',
            'field_lp_dol__torcond:[' . $min_value_price . ' TO ' . $max_value_price . ']',
          );
        }
      }
      return drupal_get_form('_ctrader_saf_search_button_form');
  }
}

/**
 * Form wit "SEARCH" button on homepage.
 */
function _ctrader_saf_search_button_form($form, &$form_state) {
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
//    '#disabled' => TRUE,
  );
  $form['geo_loc'] = array(
    '#type' => 'hidden',
  );

  $form['#attached']['js'] = array(
    drupal_get_path('module', 'ctrader_saf') . '/js/rewritten_facetapi.js',
  );
  return $form;
}


function _ctrader_saf_search_button_form_submit($form, &$form_state) {
//  $query = drupal_http_build_query($_SESSION['search_link_calculate']['f'],'f');
  $path = '/' . CTRADER_SEARCH_RESULT_PAGE;
  $url = url($path, array(
    'query' => $_SESSION['search_link_calculate'],
    'absolute' => TRUE
  ));
  $_SESSION['stored_search_options'] = $_SESSION['search_link_calculate'];
  unset($_SESSION['search_link_calculate']);
  $form_state['redirect'] = $url;
}


/**
 * @return null|string
 */
function _ctrader_saf_search_link_calculate_page_callback() {
//  unset($_SESSION['search_link_calculate_results_page']);
  if (!isset($_SESSION['search_link_calculate']['f'])) {
    $_SESSION['search_link_calculate']['f'] = array();
  }

  $set_search_option = TRUE;
  foreach ($_SESSION['search_link_calculate']['f'] as $key => $value) {
    if ($value == $_POST['/main-page?f'][0]) {
      unset($_SESSION['search_link_calculate']['f'][$key]);
      $set_search_option = FALSE;
    }

    // For sale-lease facet.
    if (strpos($value, 'field_s_r__torcond') !== FALSE && strpos($_POST['/main-page?f'][0], 'field_s_r__torcond') !== FALSE) {
      $_SESSION['search_link_calculate']['f'][$key] = $_POST['/main-page?f'][0];
      return t('page not for viewing');
    }

    // For beds facet.
    if (strpos($value, 'field_br__torcond') !== FALSE && strpos($_POST['/main-page?f'][0], 'field_br__torcond') !== FALSE) {
      $_SESSION['search_link_calculate']['f'][$key] = $_POST['/main-page?f'][0];
      return t('page not for viewing');
    }
  }
  if ($set_search_option) {
    if (isset($_POST['/main-page?f'][0])) {
      $_SESSION['search_link_calculate']['f'][] = $_POST['/main-page?f'][0];
      unset($_POST['/main-page?f']);
    }
    if (isset($_POST['/' . CTRADER_SEARCH_RESULT_PAGE . '?f'][0])) {
      $_SESSION['search_link_calculate']['f'][] = $_POST['/' . CTRADER_SEARCH_RESULT_PAGE . '?f'][0];
      unset($_POST['/' . CTRADER_SEARCH_RESULT_PAGE . '?f']);
    }
    if (isset($_POST['f'])) {
      $_SESSION['search_link_calculate']['f'][] = $_POST['f'][1];
      unset($_POST['f']);
    }
  }
  sort($_SESSION['search_link_calculate']['f']);
  return t('page not for viewing');
}


/**
 * Rewrites default submit function for facet range form (field_lp_dol__torcond).
 *
 * @param $form
 * @param $form_state
 */
function _ctrader_saf_range_ajax_form_submit($form, &$form_state) {
  $values = $form_state['values'];
  $range_field = $form_state['input']['range-field'];

  // Prepare params and existing filter $pos (if any)
  $params = drupal_get_query_parameters($_GET, array('q', 'page'));

  // Get pretty path path and goto()
  if (drupal_multilingual() && variable_get('locale_language_negotiation_url_part') == LOCALE_LANGUAGE_NEGOTIATION_URL_PREFIX) {
    list($language, $path) = language_url_split_prefix(request_path(), language_list());
    $language = $language ? $language : NULL;
  }
  else {
    $path = request_path();
    $language = NULL;
  }
  if (module_exists('facetapi_pretty_paths')) {
    $exists = FALSE;
    $split_path = explode('/', $path);
    foreach ($split_path as $key => $value) {
      if ($value == $range_field) {
        $exists = $split_path[$key + 1];
      }
    }

    // Decision: replace existing range or add new
    $new_range = '[' . $values['range-from'] . ' TO ' . $values['range-to'] . ']';
    if ($exists) {
      $path = str_replace($exists, $new_range, $path);
    }
    else {
      $path .= '/' . $range_field . '/' . $new_range;
    }

    // Unset non-pretty query
    unset($params['f']);
  }
  else {
    // Not pretty path logic
    $query = $range_field . ':' . '[' . $values['range-from'] . ' TO ' . $values['range-to'] . ']';

    $pos = -1;
    if (isset($params['f'])) {
      foreach ($params['f'] as $key => $param) {
        if (strpos($param, $range_field . ':') !== FALSE) {
          $pos = $key;
        }
      }
    }

    if ($pos != -1) {
      $params['f'][$pos] = $query;
    }
    else {
      $params['f'][] = $query;
    }
  }


  /******************** added code *****************************/
  if (isset($_SESSION['search_link_calculate']['f'])) {
    $not_in_search_query = TRUE;
    foreach ($_SESSION['search_link_calculate']['f'] as $key => $value) {
      if (strpos($value, $range_field) !== FALSE) {
        $_SESSION['search_link_calculate']['f'][$key] = $query;
        $not_in_search_query = FALSE;
      }
    }
    if ($not_in_search_query) {
      $_SESSION['search_link_calculate']['f'][] = $query;
    }
  }
  else {
    $_SESSION['search_link_calculate']['f'][] = $query;
  }
}


/**
 * Implements hook_search_api_solr_search_results_alter().
 */
function ctrader_saf_search_api_solr_search_results_alter(array &$results, SearchApiQueryInterface $query, $response) {
  $alias = drupal_get_path_alias();
  if (($alias == 'main-page' || $alias == '')) {
//    unset($_SESSION['default_solrsearch_results']);
//    $_SESSION['default_solrsearch_results'] = $results;
  }
  if ($results['result count'] == 0) {

  }
}


/**
 * Implements hook_facetapi_empty_behaviors().
 */
function ctrader_saf_facetapi_empty_behaviors() {
  return array(
    'ctrader_facet_empty_behaviors' => array(
      'handler' => array(
        'label' => t('@ctrader facet empty behavior', array('@ctrader' => 'CTrader')),
        'class' => 'FacetapiEmptyBehaviorCtrader',
      ),
    ),
  );
}


/**
 * Implements hook_facetapi_widgets().
 */
function ctrader_saf_facetapi_widgets() {
  return array(
    'ctrader_range_widget' => array(
      'handler' => array(
        'label' => t('@ctrader range', array('@ctrader' => 'CondosTrader')),
        'class' => 'SearchApiCtraderRangesWidgetUISlider',
        'query types' => array('term', 'numeric_range'),
      ),
    ),
  );
}
